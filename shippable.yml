# vim: et sr sw=2 ts=2 smartindent:
#
# Set to only build on git tag events and pull requests
# in shippable console.
language: none

env:
  global:
    - GHR="https://github.com/tcnksm/ghr/releases/download/v0.5.4/ghr_v0.5.4_linux_amd64.zip"

build:

  ci:
    - sudo apt-get update && sudo apt-get install -y coreutils realpath ;
      cd bash ;
      echo "running tests for bash libs" ;
      rc=0 ; libs="$(find . -path './t' -prune -o -name '*.functions' -print)" ;
      for lib in $libs; do
        f="t/${lib#./}" ;
        [[ -x $f ]] && ! $f && echo "failure from $lib" && rc=1 ;
      done ;
      [[ $rc -eq 0 ]]

  on_success:
    - if [[ "$IS_GIT_TAG" == "true" ]] || [[ "$IS_RELEASE" == "true" ]]; then
        sudo wget -O /var/tmp/ghr.zip "$GHR" || rc=1 ;
        echo "would build a release using $GIT_TAG_NAME" ;
      else
        echo "... not a release" ;
      fi ;
      [[ $rc -eq 0 ]]

integrations:
  hub:
    - integrationName: opsgang_dockerhubreg
      type: dockerRegistryLogin

  notifications:
    - integrationName: opsgang_slack_delivery
      type: slack
      recipients: "#delivery"
      on_success: always
      on_failure: never
      on_pull_request: never

